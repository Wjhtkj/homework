<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HJCFX2VZNJ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-HJCFX2VZNJ');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ä½œä¸šæ£€æŸ¥ Â· è‡ªé€‰ç§‘ç›®</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.23.6/antd.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', 'Roboto', sans-serif;
            background-color: #f4f6fa;
            color: #1e293b;
            padding: 16px;
            transition: background-color 0.3s, color 0.3s;
            position: relative;
            overflow-x: hidden; /* é˜²æ­¢å°å±å¹•æ¨ªå‘æ»šåŠ¨ */
        }

        body.dark-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .container {
            background-color: #ffffff;
            border-radius: 28px;
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.15), 0 5px 10px -4px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 1100px;
            padding: 28px 24px;
            transition: background-color 0.3s, box-shadow 0.3s, padding 0.2s;
            position: relative;
            margin: 60px 0 40px 0;
        }

        body.dark-mode .container {
            background-color: #1e293b;
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.6);
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .subhead {
            color: #64748b;
            margin-bottom: 28px;
            font-size: 0.95rem;
            border-left: 4px solid #818cf8;
            padding-left: 12px;
        }

        body.dark-mode .subhead {
            color: #94a3b8;
        }

        /* äººå‘˜å¡ç‰‡ç½‘æ ¼ */
        .people-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin: 32px 0 28px;
        }

        .person-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 20px 18px;
            border: 1px solid #e9eef2;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }

        body.dark-mode .person-card {
            background: #2d3a4f;
            border-color: #334155;
        }

        .person-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            font-weight: 600;
            font-size: 1.3rem;
            border-bottom: 2px dashed #cbd5e1;
            padding-bottom: 8px;
        }

        body.dark-mode .person-header {
            border-bottom-color: #475569;
        }

        .person-name {
            background: #e0e7ff;
            color: #4338ca;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 1.1rem;
            word-break: break-word; /* é•¿åå­—æŠ˜è¡Œ */
        }

        body.dark-mode .person-name {
            background: #4f46e5;
            color: #ffffff;
        }

        /* å­¦ç§‘è¡Œ */
        .subject-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 14px;
            background: #ffffff;
            padding: 12px 16px;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
        }

        body.dark-mode .subject-row {
            background: #1e293b;
            border-color: #475569;
        }

        .subject-check {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 70px;
        }
        .subject-check input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
            cursor: pointer;
            flex-shrink: 0;
        }
        .subject-check label {
            font-weight: 600;
            font-size: 1.05rem;
            margin: 0;
            cursor: pointer;
            color: #1e293b;
            white-space: nowrap;
        }
        body.dark-mode .subject-check label {
            color: #f1f5f9;
        }

        .dimension-selects {
            display: flex;
            flex: 2 1 400px;
            flex-wrap: wrap;
            gap: 8px 16px;
        }

        .dim-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f1f5f9;
            padding: 4px 12px 4px 8px;
            border-radius: 30px;
            font-size: 0.9rem;
            min-width: 140px;  /* ä¿è¯æœ€å°å®½åº¦ï¼Œé¿å…å¤ªçª„ */
            flex: 1 0 auto;
        }
        body.dark-mode .dim-item {
            background: #334155;
        }

        .dim-item select {
            border: none;
            background: transparent;
            font-weight: 500;
            padding: 6px 4px;
            font-size: 0.9rem;
            border-radius: 20px;
            outline: none;
            cursor: pointer;
            color: #0f172a;
            flex: 1;  /* è®©selectå æ®å‰©ä½™å®½åº¦ */
            min-width: 80px;  /* ç¡®ä¿åœ¨å°å±ä¸Šå¯ç‚¹ */
        }
        body.dark-mode .dim-item select {
            color: #f1f5f9;
            background-color: #475569;
        }
        .dim-item select option {
            background: white;
            color: black;
        }
        body.dark-mode .dim-item select option {
            background: #2d3a4f;
            color: #f1f5f9;
        }

        .dim-label {
            font-weight: 500;
            color: #475569;
            white-space: nowrap;
        }
        body.dark-mode .dim-label {
            color: #cbd5e1;
        }

        /* æŒ‰é’®ç»„ */
        .action-bar {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0 20px;
        }

        .primary-btn {
            background: #4f46e5;
            border: none;
            padding: 14px 36px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.1rem;
            color: white;
            box-shadow: 0 8px 16px -6px #a5b4fc;
            transition: 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            min-width: 160px;
            flex: 0 1 auto;
        }
        .primary-btn:hover {
            background: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 14px 22px -8px #818cf8;
        }
        .secondary-btn {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            padding: 14px 36px;
            border-radius: 60px;
            font-weight: 500;
            color: #334155;
            transition: 0.2s;
            cursor: pointer;
            min-width: 160px;
            flex: 0 1 auto;
        }
        .secondary-btn:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        body.dark-mode .secondary-btn {
            background: #1e293b;
            color: #f1f5f9;
            border-color: #64748b;
        }
        body.dark-mode .secondary-btn:hover {
            background: #2d3a4f;
        }

        textarea {
            width: 100%;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            padding: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 20px 0 10px;
            resize: vertical;
            color: #1e293b;
        }
        body.dark-mode textarea {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .settings-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            color: #1e293b;
            box-shadow: 0 6px 12px rgba(0,0,0,0.04);
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: 0.2s;
            z-index: 100;
            font-size: 0.95rem;
        }
        .settings-button:hover {
            background: #f1f5f9;
            transform: scale(1.02);
        }
        body.dark-mode .settings-button {
            background: #1e293b;
            color: #f1f5f9;
            border-color: #475569;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        .modal-content {
            background: white;
            max-width: 460px;
            width: 100%;
            border-radius: 36px;
            padding: 28px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
            animation: modalFade 0.2s;
            max-height: 90vh;
            overflow-y: auto;
        }
        body.dark-mode .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
        }
        @keyframes modalFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close {
            float: right;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: #94a3b8;
            line-height: 1;
        }
        .close:hover { color: #1e293b; }
        body.dark-mode .close:hover { color: #f1f5f9; }

        .modal-input-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin: 24px 0;
        }
        .modal-input-group input, .modal-input-group select {
            padding: 14px 18px;
            border-radius: 30px;
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            font-size: 1rem;
            width: 100%;
        }
        body.dark-mode .modal-input-group input,
        body.dark-mode .modal-input-group select {
            background: #0f172a;
            border-color: #475569;
            color: #f1f5f9;
        }
        /* ç§‘ç›®å¤šé€‰æ ·å¼ */
        .subject-picker {
            background: #f1f5f9;
            border-radius: 28px;
            padding: 16px 20px;
            margin-top: 8px;
        }
        .subject-picker p {
            font-weight: 600;
            margin-bottom: 12px;
        }
        .subject-picker label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 24px;
            cursor: pointer;
            white-space: nowrap; /* é˜²æ­¢æ¢è¡Œ */
        }
        .subject-picker input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }

        .footer {
            text-align: center;
            margin-top: 28px;
            font-size: 0.85rem;
            color: #64748b;
        }
        .footer a { color: #4f46e5; text-decoration: none; font-weight: 500; }
        body.dark-mode .footer a { color: #a5b4fc; }

        /* ========== å“åº”å¼å¢å¼º (é€‚é…å„ç§å±å¹•) ========== */
        @media (max-width: 700px) {
            .container {
                padding: 22px 18px;
            }
            h1 {
                font-size: 1.9rem;
            }
        }

        @media (max-width: 600px) {
            .subject-row {
                flex-direction: column;
                align-items: stretch;
            }
            .subject-check {
                margin-bottom: 4px;
            }
            .dimension-selects {
                flex-direction: column;
                gap: 10px;
            }
            .dim-item {
                width: 100%;
                justify-content: space-between;
            }
            .dim-item select {
                max-width: 60%;  /* åœ¨éå¸¸å°çš„å±å¹•ä¸Šç»™selectæ›´å¤šç©ºé—´ */
            }
            .action-bar button {
                width: 100%;
                min-width: unset;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            .container {
                padding: 18px 14px;
                border-radius: 24px;
                margin-top: 70px;  /* ä¸ºå›ºå®šè®¾ç½®æŒ‰é’®è®©å‡ºç©ºé—´ */
            }
            h1 {
                font-size: 1.7rem;
            }
            .person-card {
                padding: 16px 12px;
            }
            .person-header {
                font-size: 1.1rem;
            }
            .person-name {
                font-size: 1rem;
                padding: 4px 14px;
            }
            .subject-check label {
                font-size: 1rem;
            }
            .dim-item {
                font-size: 0.85rem;
                padding: 6px 10px;
            }
            .dim-item select {
                font-size: 0.85rem;
                padding: 5px 2px;
            }
            .settings-button {
                padding: 8px 18px;
                font-size: 0.9rem;
                top: 12px;
                right: 12px;
            }
            .modal-content {
                padding: 20px;
            }
            .subject-picker label {
                white-space: normal;  /* å°å±å¯æ¢è¡Œ */
                margin-right: 12px;
                margin-bottom: 6px;
            }
        }

        /* è¶…å°å± (<=360px) */
        @media (max-width: 360px) {
            .dim-item {
                flex-wrap: wrap;
                gap: 4px;
            }
            .dim-label {
                width: 100%;
            }
            .dim-item select {
                max-width: 100%;
                width: 100%;
            }
            .subject-check label {
                white-space: normal;
                word-break: break-word;
            }
            .subject-picker label {
                display: flex;
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <button class="settings-button" onclick="openSettingsModal()">âš™ï¸ è®¾ç½®</button>

    <div class="container">
        <h1>ğŸ“‹ ä½œä¸šæ£€æŸ¥ Â· è‡ªé€‰ç§‘ç›®</h1>
        <div class="subhead">å®Œæˆç¨‹åº¦ Â· å­—ä½“ Â· è¿‡ç¨‹å®Œæ•´åº¦ â€” æ¯ä½æˆå‘˜ç‹¬ç«‹å‹¾é€‰éœ€æ£€æŸ¥çš„ç§‘ç›®</div>

        <!-- åŠ¨æ€æ¸²æŸ“çš„äººå‘˜å¡ç‰‡ä¼šæ’å…¥è¿™é‡Œ -->
        <div id="peopleContainer" class="people-grid"></div>

        <div class="action-bar">
            <button class="primary-btn" onclick="generateReport()">ğŸ“‹ ç”ŸæˆæŠ¥å‘Š</button>
            <button class="secondary-btn" onclick="copyReport()">ğŸ“ å¤åˆ¶æŠ¥å‘Š</button>
        </div>

        <textarea id="outputText" rows="6" placeholder="æŠ¥å‘Šå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>

        <div class="footer">
            âœ¦ æ— é™…èˆªå¤© âœ¦ <a href="https://wjhtkjwz.eu.org/" target="_blank">å»åšå®¢çœ‹çœ‹</a>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† (ç§»é™¤ç»„é•¿æ¨¡å¼ï¼Œå¢åŠ ç§‘ç›®å¤šé€‰) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettingsModal()">&times;</span>
            <h2 style="margin-top: 0;">âš™ï¸ åˆå§‹è®¾ç½®</h2>
            <div class="modal-input-group">
                <input type="text" id="name1" placeholder="ç»„å‘˜1 å§“å">
                <input type="text" id="name2" placeholder="ç»„å‘˜2 å§“å">
                <input type="text" id="name3" placeholder="ç»„å‘˜3 å§“å">
                <input type="text" id="name4" placeholder="ç»„å‘˜4 å§“å">
                <input type="text" id="name5" placeholder="ç»„å‘˜5 å§“å">
                <input type="text" id="name6" placeholder="ç»„å‘˜6 å§“å">
                <select id="groupSelect">
                    <option value="1">ç¬¬1ç»„</option><option value="2">ç¬¬2ç»„</option><option value="3">ç¬¬3ç»„</option>
                    <option value="4">ç¬¬4ç»„</option><option value="5">ç¬¬5ç»„</option><option value="6">ç¬¬6ç»„</option>
                    <option value="7">ç¬¬7ç»„</option><option value="8">ç¬¬8ç»„</option><option value="9">ç¬¬9ç»„</option>
                </select>

                <!-- ç§‘ç›®å¤šé€‰ (å…¨å±€) -->
                <div class="subject-picker">
                    <p>ğŸ“Œ é€‰æ‹©è¦æ£€æŸ¥çš„ç§‘ç›®</p>
                    <label><input type="checkbox" id="subjPhys" value="ç‰©ç†" checked> ç‰©ç†</label>
                    <label><input type="checkbox" id="subjChem" value="åŒ–å­¦" checked> åŒ–å­¦</label>
                    <label><input type="checkbox" id="subjBio" value="ç”Ÿç‰©" checked> ç”Ÿç‰©</label>
                </div>
            </div>
            <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="darkModeToggle"> æš—é»‘æ¨¡å¼
            </label>
            <!-- å·²ç§»é™¤ç»„é•¿æ¨¡å¼å¤é€‰æ¡† -->
            <button class="primary-btn" onclick="saveSettings()" style="width:100%; margin-top:20px;">ä¿å­˜å¹¶å¼€å§‹</button>
        </div>
    </div>

    <script>
        (function() {
            // ----- æ ¸å¿ƒæ•°æ® & ç»´åº¦å®šä¹‰ -----
            const DIMENSIONS = {
                completion: { label: 'å®Œæˆç¨‹åº¦', options: ['å®Œæˆè‰¯å¥½', 'æœªå®Œæˆ', 'éƒ¨åˆ†å®Œæˆ'] },
                font: { label: 'å­—ä½“', options: ['å·¥æ•´', 'æ½¦è‰', 'ä¸€èˆ¬'] },
                process: { label: 'è¿‡ç¨‹å®Œæ•´åº¦', options: ['å®Œæ•´', 'ç¼ºå°‘æ­¥éª¤', 'ä¸å®Œæ•´'] }
            };

            const BEST_VALUES = {
                completion: 'å®Œæˆè‰¯å¥½',
                font: 'å·¥æ•´',
                process: 'å®Œæ•´'
            };

            // å›ºå®šåŸºç¡€ç§‘ç›® (ä¸å†ä½¿ç”¨ç»„é•¿æ¨¡å¼)
            const ALL_SUBJECTS = ['ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©'];

            // ----- è·å–è¦æ˜¾ç¤ºçš„ç§‘ç›® (æ ¹æ®æœ¬åœ°å­˜å‚¨çš„é€‰ä¸­ç§‘ç›®) -----
            function getSelectedSubjects() {
                const stored = localStorage.getItem('selectedSubjects');
                if (stored) {
                    try {
                        const arr = JSON.parse(stored);
                        // è¿‡æ»¤æ‰å¯èƒ½ä¸å­˜åœ¨çš„ç§‘ç›® (ä½†ä¿ç•™æœ‰æ•ˆå€¼)
                        return arr.filter(s => ALL_SUBJECTS.includes(s));
                    } catch (e) {
                        return [...ALL_SUBJECTS]; // å‡ºé”™æ—¶è¿”å›å…¨éƒ¨
                    }
                }
                return [...ALL_SUBJECTS]; // é»˜è®¤å…¨éƒ¨
            }

            // ----- æ¸²æŸ“äººå‘˜å¡ç‰‡ (åŸºäºé€‰ä¸­çš„ç§‘ç›®) -----
            function renderPeople() {
                const container = document.getElementById('peopleContainer');
                if (!container) return;
                
                const savedNames = JSON.parse(localStorage.getItem('names')) || ['1', '2', '3', '4', '5', '6'];
                const subjects = getSelectedSubjects();   // ä»…æ˜¾ç¤ºç”¨æˆ·å‹¾é€‰çš„ç§‘ç›®

                let html = '';
                for (let p = 0; p < 6; p++) {
                    const personName = savedNames[p] || (p+1).toString();
                    html += `<div class="person-card" data-person-index="${p}">`;
                    html += `<div class="person-header"><span class="person-name">ğŸ‘¤ ${personName}</span></div>`;

                    subjects.forEach((subject, subjIdx) => {
                        html += `<div class="subject-row" data-subject="${subject}">`;
                        // ä¸ªäººçº§åˆ«å¤é€‰æ¡† (é»˜è®¤å‹¾é€‰ï¼Œè¡¨ç¤ºè¯¥æˆå‘˜æ­¤ç§‘ç›®å‚ä¸æŠ¥å‘Š)
                        html += `<div class="subject-check">`;
                        html += `<input type="checkbox" class="subject-checkbox" id="chk_${p}_${subjIdx}" checked>`;
                        html += `<label for="chk_${p}_${subjIdx}">${subject}</label>`;
                        html += `</div>`;

                        // ä¸‰ä¸ªç»´åº¦ä¸‹æ‹‰
                        html += `<div class="dimension-selects">`;
                        // å®Œæˆç¨‹åº¦
                        html += `<div class="dim-item"><span class="dim-label">å®Œæˆ</span>`;
                        html += `<select class="dim-completion" data-dim="completion">`;
                        DIMENSIONS.completion.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
                        html += `</select></div>`;
                        // å­—ä½“
                        html += `<div class="dim-item"><span class="dim-label">å­—ä½“</span>`;
                        html += `<select class="dim-font" data-dim="font">`;
                        DIMENSIONS.font.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
                        html += `</select></div>`;
                        // è¿‡ç¨‹å®Œæ•´åº¦
                        html += `<div class="dim-item"><span class="dim-label">è¿‡ç¨‹</span>`;
                        html += `<select class="dim-process" data-dim="process">`;
                        DIMENSIONS.process.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
                        html += `</select></div>`;
                        html += `</div>`; // dimension-selects
                        html += `</div>`; // subject-row
                    });
                    html += `</div>`; // person-card
                }
                container.innerHTML = html;
            }

            // ----- ç”ŸæˆæŠ¥å‘Š (åŸºäºå…¨å±€é€‰ä¸­ç§‘ç›® + ä¸ªäººå‹¾é€‰) -----
            function generateReport() {
                const subjects = getSelectedSubjects();  // å…¨å±€æ˜¾ç¤ºçš„ç§‘ç›®
                const savedNames = JSON.parse(localStorage.getItem('names')) || ['1', '2', '3', '4', '5', '6'];
                const group = JSON.parse(localStorage.getItem('group')) || '1';

                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-CN', { year:'numeric', month:'2-digit', day:'2-digit' });

                // å­˜å‚¨æ¯ä¸ªç§‘ç›®çš„é—®é¢˜åˆ—è¡¨
                const subjectIssues = {};
                subjects.forEach(s => subjectIssues[s] = []);

                const cards = document.querySelectorAll('.person-card');
                cards.forEach((card, personIdx) => {
                    const personName = savedNames[personIdx] || (personIdx+1).toString();
                    const rows = card.querySelectorAll('.subject-row');
                    
                    rows.forEach((row) => {
                        const chk = row.querySelector('.subject-checkbox');
                        if (!chk || !chk.checked) return; // ä¸ªäººæœªå‹¾é€‰æ­¤ç§‘ç›®

                        // è·å–ç§‘ç›®åç§° (ä» data-subject æˆ–è¡Œå†…æ–‡æœ¬)
                        let subject = row.dataset.subject;
                        if (!subject) {
                            // åå¤‡ï¼šä»labelè·å–
                            const label = row.querySelector('.subject-check label');
                            subject = label ? label.innerText.trim() : '';
                        }
                        if (!subject || !subjects.includes(subject)) return; // å®‰å…¨è¿‡æ»¤

                        const completion = row.querySelector('.dim-completion')?.value || '';
                        const font = row.querySelector('.dim-font')?.value || '';
                        const process = row.querySelector('.dim-process')?.value || '';

                        const isAllBest = (completion === BEST_VALUES.completion && 
                                           font === BEST_VALUES.font && 
                                           process === BEST_VALUES.process);

                        if (!isAllBest) {
                            const faults = [];
                            if (completion !== BEST_VALUES.completion) faults.push(`å®Œæˆ:${completion}`);
                            if (font !== BEST_VALUES.font) faults.push(`å­—ä½“:${font}`);
                            if (process !== BEST_VALUES.process) faults.push(`è¿‡ç¨‹:${process}`);
                            const detail = faults.join('; ');
                            subjectIssues[subject].push(`${personName} (${detail})`);
                        }
                    });
                });

                let output = `ç¬¬${group}ç»„ ${dateStr} ä½œä¸šå®Œæˆæƒ…å†µ\n`;
                subjects.forEach(subject => {
                    const issues = subjectIssues[subject];
                    if (issues.length === 0) {
                        output += `${subject}ï¼šå…¨å‘˜è‰¯å¥½\n`;
                    } else {
                        output += `${subject}ï¼š${issues.join('ï¼› ')}\n`;
                    }
                });

                const outputEl = document.getElementById('outputText');
                if (outputEl) outputEl.value = output;
            }

            function copyReport() {
                const output = document.getElementById('outputText');
                if (!output.value.trim()) {
                    alert('è¿˜æ²¡æœ‰ç”ŸæˆæŠ¥å‘Šï¼Œè¯·å…ˆç‚¹å‡»â€œç”ŸæˆæŠ¥å‘Šâ€');
                    return;
                }
                output.select();
                output.setSelectionRange(0, 99999);
                document.execCommand('copy');
                alert('æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }

            // ----- è®¾ç½®ç›¸å…³ -----
            function openSettingsModal() {
                // å¡«å……å§“å
                const savedNames = JSON.parse(localStorage.getItem('names')) || ['1', '2', '3', '4', '5', '6'];
                for (let i=1; i<=6; i++) {
                    const input = document.getElementById(`name${i}`);
                    if (input) input.value = savedNames[i-1];
                }

                // ç»„åˆ«
                const group = JSON.parse(localStorage.getItem('group')) || '1';
                const groupSelect = document.getElementById('groupSelect');
                if (groupSelect) groupSelect.value = group;

                // æš—é»‘æ¨¡å¼
                const dark = JSON.parse(localStorage.getItem('darkMode')) || false;
                document.getElementById('darkModeToggle').checked = dark;

                // ç§‘ç›®å¤é€‰æ¡†ï¼šä» localStorage è¯»å–é€‰ä¸­ç§‘ç›®ï¼Œé»˜è®¤å…¨é€‰
                const selected = getSelectedSubjects();  // è¿”å›æ•°ç»„
                document.getElementById('subjPhys').checked = selected.includes('ç‰©ç†');
                document.getElementById('subjChem').checked = selected.includes('åŒ–å­¦');
                document.getElementById('subjBio').checked = selected.includes('ç”Ÿç‰©');

                document.getElementById('settingsModal').style.display = 'flex';
            }

            function closeSettingsModal() {
                document.getElementById('settingsModal').style.display = 'none';
            }

            function saveSettings() {
                // ä¿å­˜å§“å
                const names = [];
                for (let i=1; i<=6; i++) {
                    names.push(document.getElementById(`name${i}`).value.trim() || (i).toString());
                }
                localStorage.setItem('names', JSON.stringify(names));

                // ç»„åˆ«
                const group = document.getElementById('groupSelect').value;
                localStorage.setItem('group', JSON.stringify(group));

                // æš—é»‘æ¨¡å¼
                const dark = document.getElementById('darkModeToggle').checked;
                localStorage.setItem('darkMode', JSON.stringify(dark));
                applyDarkMode(dark);

                // ä¿å­˜é€‰ä¸­çš„ç§‘ç›®
                const selectedSubjects = [];
                if (document.getElementById('subjPhys').checked) selectedSubjects.push('ç‰©ç†');
                if (document.getElementById('subjChem').checked) selectedSubjects.push('åŒ–å­¦');
                if (document.getElementById('subjBio').checked) selectedSubjects.push('ç”Ÿç‰©');
                // å¦‚æœå•¥éƒ½æ²¡é€‰ï¼Œç»™ä¸ªé»˜è®¤ç‰©ç† (é¿å…ç©ºç•Œé¢)
                if (selectedSubjects.length === 0) selectedSubjects.push('ç‰©ç†');
                localStorage.setItem('selectedSubjects', JSON.stringify(selectedSubjects));

                // é‡æ–°æ¸²æŸ“å¡ç‰‡ (æ ¹æ®æ–°ç§‘ç›®)
                renderPeople();

                closeSettingsModal();
                // ä¸è‡ªåŠ¨å¼¹alertï¼Œé¿å…å¹²æ‰°
            }

            function applyDarkMode(enabled) {
                if (enabled) document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            }

            // åˆå§‹åŒ–ï¼šå¦‚æœä»æœªè®¾ç½®è¿‡ç§‘ç›®ï¼ˆç¬¬ä¸€æ¬¡è®¿é—®ï¼‰ï¼Œè‡ªåŠ¨æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
            function firstTimeSetup() {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»»ä½•ç”¨æˆ·è®¾ç½® (å¯ä»¥æ£€æµ‹selectedSubjects)
                const hasSubjects = localStorage.getItem('selectedSubjects') !== null;
                // åŒæ—¶æ£€æµ‹æ˜¯å¦æœ‰å§“å (å¯é€‰)
                if (!hasSubjects) {
                    // é¦–æ¬¡è®¿é—®ï¼Œè‡ªåŠ¨æ‰“å¼€è®¾ç½®æ¡†
                    setTimeout(() => {
                        openSettingsModal();
                    }, 100); // ç•¥å¾®å»¶è¿Ÿç¡®ä¿DOMåŠ è½½
                }
                // æ— è®ºå¦‚ä½•éƒ½æ¸²æŸ“ä¸€æ¬¡
                renderPeople();
            }

            // é¡µé¢åŠ è½½
            window.addEventListener('load', function() {
                // é»˜è®¤å€¼åˆå§‹åŒ– (é˜²æ­¢ç¼ºå¤±)
                if (!localStorage.getItem('names')) {
                    localStorage.setItem('names', JSON.stringify(['1', '2', '3', '4', '5', '6']));
                }
                if (!localStorage.getItem('group')) {
                    localStorage.setItem('group', JSON.stringify('1'));
                }
                if (!localStorage.getItem('darkMode')) {
                    localStorage.setItem('darkMode', JSON.stringify(false));
                }
                // selectedSubjects ä¸åœ¨è¿™é‡Œé¢„è®¾ï¼Œç•™ç»™ firstTimeSetup åˆ¤æ–­

                const dark = JSON.parse(localStorage.getItem('darkMode'));
                applyDarkMode(dark);

                firstTimeSetup();
                document.getElementById('outputText').value = '';
            });

            // æš´éœ²å…¨å±€å‡½æ•°
            window.generateReport = generateReport;
            window.copyReport = copyReport;
            window.openSettingsModal = openSettingsModal;
            window.closeSettingsModal = closeSettingsModal;
            window.saveSettings = saveSettings;
        })();
    </script>
</body>
</html>
