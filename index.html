<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Â∞èÁªÑ‰Ωú‰∏öÊ£ÄÊü•Â∑•ÂÖ∑</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* ÂéªÈô§ÁßªÂä®Á´ØÈªòËÆ§ÁÅ∞Ëâ≤È´ò‰∫Æ */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fc;
            color: #1f2a44;
            padding: 20px;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.2s ease;
        }
        body.dark {
            background-color: #121826;
            color: #e0e4f0;
        }
        body.dark .card {
            background-color: #1e2436;
            border: 1px solid #2f3b5c;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
        }
        body.dark .dimension-group .option-btn {
            background-color: #2b3147;
            border-color: #3e4b6b;
            color: #cbd5e6;
        }
        body.dark .dimension-group .option-btn.selected {
            background-color: #2f5a8c;
            border-color: #4a7bb3;
            color: white;
        }
        body.dark .subject-checkbox+label {
            background-color: #2b3147;
            border-color: #4a5a7a;
        }
        body.dark .modal-content {
            background-color: #222837;
            color: #eef2f9;
            border: 1px solid #384562;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 15px;
        }
        h1 {
            font-weight: 600;
            font-size: 2rem;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #1d4e7f, #0f2c4b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        body.dark h1 {
            background: linear-gradient(135deg, #90b4de, #c0d4f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .settings-btn {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 40px;
            padding: 12px 28px;  /* Â¢ûÂ§ßËß¶Êë∏Âå∫Âüü */
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.9, 0.3, 1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            min-height: 48px; /* Á°Æ‰øùËß¶Êë∏È´òÂ∫¶ */
        }
        .settings-btn:hover {
            background-color: #eaf0f9;
            border-color: #7f9bc0;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 30, 60, 0.12);
        }
        .settings-btn:active {
            transform: scale(0.97);
            transition: transform 0.05s;
        }
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* ÊâãÊú∫Êõ¥ÂêàÈÄÇ */
            gap: 20px;
            margin-bottom: 36px;
        }
        .card {
            background: white;
            border-radius: 28px;
            padding: 24px 18px;
            box-shadow: 0 15px 30px rgba(0, 20, 40, 0.06);
            border: 1px solid #e9eef4;
            transition: transform 0.2s cubic-bezier(0.2, 0.9, 0.3, 1.1), box-shadow 0.3s ease;
            cursor: default;
        }
        .card:active {
            background-color: #f8faff; /* Ëß¶Êë∏ÂèçÈ¶à */
            transform: scale(0.99);
        }
        body.dark .card:active {
            background-color: #252d42;
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
            font-weight: 600;
            padding-bottom: 18px;
            margin-bottom: 12px;
            border-bottom: 2px solid #eef3fa;
        }
        body.dark .card-header {
            border-bottom-color: #2e3c58;
        }
        .subject-row {
            margin-bottom: 24px;
            padding: 8px 0 8px 8px;
            border-radius: 16px;
            background: rgba(235, 245, 255, 0.3);
            transition: background 0.2s;
        }
        body.dark .subject-row {
            background: rgba(30, 45, 80, 0.3);
        }
        .subject-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .subject-name {
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 60px;
            color: #1d3b66;
        }
        body.dark .subject-name {
            color: #b2cef0;
        }
        .subject-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .subject-checkbox+label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 30px;
            padding: 8px 18px 8px 14px; /* Â¢ûÂ§ßËß¶Êë∏Âå∫Âüü */
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.1s;
            user-select: none;
            min-height: 44px; /* Ëß¶Êë∏È´òÂ∫¶ */
        }
        .subject-checkbox+label::before {
            content: "‚òê";
            font-size: 1.2rem;
            margin-right: 4px;
            transition: content 0.1s;
        }
        .subject-checkbox:checked+label::before {
            content: "‚úÖ";
        }
        .subject-checkbox:checked+label {
            background: #e1f0fa;
            border-color: #2f6ea2;
            color: #0d3e66;
        }
        .subject-checkbox+label:active {
            transform: scale(0.96);
        }
        body.dark .subject-checkbox:checked+label {
            background: #1d4468;
            border-color: #6190c0;
            color: #d5e9ff;
        }

        .dimensions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 16px;
            margin-left: 4px;
        }
        .dimension-group {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .dimension-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #4f658d;
            min-width: 44px;
        }
        body.dark .dimension-label {
            color: #a5b9da;
        }
        .option-group {
            display: flex;
            gap: 4px;
            background: #f2f6fd;
            padding: 4px;
            border-radius: 40px;
            border: 1px solid #dae2ed;
        }
        body.dark .option-group {
            background: #262e45;
            border-color: #3e5075;
        }
        .option-btn {
            background: transparent;
            border: none;
            padding: 8px 16px; /* Â¢ûÂ§ßËß¶Êë∏Âå∫Âüü */
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2a44;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s, color 0.15s, transform 0.1s;
            white-space: nowrap;
            border: 1px solid transparent;
            min-height: 44px;
            min-width: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .option-btn.selected {
            background: white;
            border-color: #2f6ea2;
            box-shadow: 0 2px 8px rgba(0,80,150,0.1);
            color: #0c4b81;
            font-weight: 600;
        }
        body.dark .option-btn.selected {
            background: #2f5580;
            border-color: #7fa9d5;
            color: white;
        }
        .option-btn:active {
            transform: scale(0.94);
            background: rgba(70, 130, 200, 0.15);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0 30px;
            flex-wrap: wrap;
        }
        .primary-btn, .secondary-btn {
            padding: 14px 36px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.9, 0.3, 1.1);
            border: none;
            box-shadow: 0 10px 20px -5px rgba(20,60,130,0.2);
            min-height: 56px;
            min-width: 160px;
        }
        .primary-btn {
            background: #1d3e6b;
            color: white;
        }
        .primary-btn:active {
            transform: scale(0.96);
            background: #0f2e4f;
        }
        .secondary-btn {
            background: white;
            color: #1f2a44;
            border: 1px solid #b9cbeb;
            box-shadow: none;
        }
        .secondary-btn:active {
            transform: scale(0.96);
            background: #d9e4f5;
        }
        body.dark .secondary-btn {
            background: #262e45;
            color: #dfe7f5;
            border-color: #4e6190;
        }
        .report-box {
            background: #fafdff;
            border-radius: 32px;
            padding: 20px;
            border: 1px solid #d9e4f0;
        }
        body.dark .report-box {
            background: #1b2133;
            border-color: #32415e;
        }
        textarea {
            width: 100%;
            padding: 20px 24px;
            border-radius: 28px;
            border: 1px solid #d4e0ec;
            font-family: 'Inter', monospace;
            font-size: 1rem;
            line-height: 1.7;
            resize: vertical;
            background: white;
            color: #1c293b;
            outline: none;
            min-height: 200px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus {
            border-color: #2f6ea2;
            box-shadow: 0 0 0 3px rgba(47, 110, 162, 0.2);
        }
        body.dark textarea {
            background: #1d2338;
            color: #cdd9f0;
            border-color: #36496b;
        }
        body.dark textarea:focus {
            border-color: #7fa9d5;
            box-shadow: 0 0 0 3px rgba(127, 169, 213, 0.3);
        }
        .footer {
            text-align: center;
            margin-top: 60px;
            color: #667c9e;
            font-size: 1rem;
            transition: color 0.2s;
        }
        .footer a {
            color: #1d4e89;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            padding: 8px;
            display: inline-block;
        }
        .footer a:active {
            opacity: 0.7;
        }

        /* Ê®°ÊÄÅÊ°ÜÂä®Áîª - ‰ªéÂ∫ïÈÉ®ÊªëÂÖ• */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0);
            backdrop-filter: blur(0px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: background 0.3s, backdrop-filter 0.3s;
        }
        .modal.show {
            display: flex;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white;
            max-width: 550px;
            width: 90%;
            border-radius: 48px;
            padding: 36px 28px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(30px) scale(0.95);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(0.2, 0.9, 0.3, 1.1), opacity 0.25s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal-content h2 {
            margin-bottom: 20px;
            font-weight: 600;
        }
        .input-group {
            margin-bottom: 24px;
        }
        .member-row input {
            width: 100%;
            padding: 16px 22px; /* Â¢ûÂ§ßËß¶Êë∏ */
            border-radius: 50px;
            border: 1px solid #cbd5e1;
            font-size: 1rem;
            margin-bottom: 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 56px;
        }
        .member-row input:focus {
            border-color: #2f6ea2;
            box-shadow: 0 0 0 3px rgba(47, 110, 162, 0.2);
            outline: none;
        }
        .group-select {
            width: 100%;
            padding: 16px 24px;
            border-radius: 50px;
            border: 1px solid #cbd5e1;
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 56px;
            font-size: 1rem;
        }
        .group-select:focus {
            border-color: #2f6ea2;
            box-shadow: 0 0 0 3px rgba(47, 110, 162, 0.2);
            outline: none;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: color 0.2s;
            padding: 8px 0;
            min-height: 44px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: #1d3e6b;
        }
        .dark-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 28px 0;
            min-height: 48px;
        }
        .save-btn {
            background: #1d3e6b;
            color: white;
            border: none;
            width: 100%;
            padding: 18px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            min-height: 64px;
        }
        .save-btn:active {
            transform: scale(0.97);
            background: #0f2e4f;
        }
        .close-icon {
            float: right;
            font-size: 2.4rem;
            line-height: 1;
            cursor: pointer;
            background: none;
            border: none;
            color: #666;
            transition: color 0.2s, transform 0.2s;
            padding: 8px;
            min-width: 56px;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-icon:active {
            transform: rotate(90deg) scale(0.9);
            color: #000;
        }
        body.dark .close-icon {
            color: #aaa;
        }
        body.dark .close-icon:active {
            color: #fff;
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="header">
        <h1>üìã Â∞èÁªÑ‰Ωú‰∏öÊ£ÄÊü•</h1>
        <button class="settings-btn" id="openSettingsBtn">‚öôÔ∏è ËÆæÁΩÆ</button>
    </div>

    <div id="membersContainer" class="members-grid"></div>

    <div class="action-buttons">
        <button class="primary-btn" id="generateReportBtn">üìÑ ÁîüÊàêÊä•Âëä</button>
        <button class="secondary-btn" id="copyReportBtn">üìã Â§çÂà∂Êä•Âëä</button>
    </div>

    <div class="report-box">
        <textarea id="reportText" placeholder="ÁîüÊàêÁöÑÊä•Âëä‰ºöÊòæÁ§∫Âú®ËøôÈáå‚Ä¶‚Ä¶" readonly></textarea>
    </div>

    <div class="footer">
        ‚ú¶ Êó†ÈôÖËà™Â§© ‚ú¶ ÂçöÂÆ¢ <a href="https://wjhtkjwz.eu.org/" target="_blank">wjhtkjwz.eu.org</a>
    </div>
</div>

<!-- ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <button class="close-icon" id="closeModalBtn">&times;</button>
        <h2>‚öôÔ∏è ÈÖçÁΩÆÂ∞èÁªÑ</h2>
        <div class="input-group">
            <label>üë• ÂÖ≠‰ΩçÁªÑÂëòÂßìÂêç</label>
            <div id="memberInputs"></div>
        </div>
        <div class="input-group">
            <label>üìå ÁªÑÂà´</label>
            <select id="groupSelect" class="group-select">
                <option>Á¨¨1ÁªÑ</option><option>Á¨¨2ÁªÑ</option><option>Á¨¨3ÁªÑ</option>
                <option>Á¨¨4ÁªÑ</option><option>Á¨¨5ÁªÑ</option><option>Á¨¨6ÁªÑ</option>
                <option>Á¨¨7ÁªÑ</option><option>Á¨¨8ÁªÑ</option><option>Á¨¨9ÁªÑ</option>
            </select>
        </div>
        <div class="input-group">
            <label>üìö Ê£ÄÊü•ÁßëÁõÆ (ÂèØÂ§öÈÄâ)</label>
            <div class="checkbox-group" id="subjectsCheckboxGroup"></div>
        </div>
        <div class="dark-switch">
            <span>üåô ÊöóÈªëÊ®°Âºè</span>
            <label><input type="checkbox" id="darkModeCheckbox"> ÂºÄÂêØ</label>
        </div>
        <button class="save-btn" id="saveSettingsBtn">‰øùÂ≠òÂπ∂ÂºÄÂßã</button>
    </div>
</div>

<script>
    (function() {
        const ALL_SUBJECTS = ["ËØ≠Êñá", "Êï∞Â≠¶", "Ëã±ËØ≠", "Áâ©ÁêÜ", "ÂåñÂ≠¶", "ÁîüÁâ©"];
        const COMPLETION_OPTS = ["ÂÆåÊàêËâØÂ•Ω", "Êú™ÂÆåÊàê", "ÈÉ®ÂàÜÂÆåÊàê"];
        const FONT_OPTS = ["Â∑•Êï¥", "ÊΩ¶Ëçâ", "‰∏ÄËà¨"];
        const PROCESS_OPTS = ["ËøáÁ®ãÂÆåÊï¥", "Áº∫Â∞ëÊ≠•È™§", "ËæÉÂÆåÊï¥"];

        let settings = {
            memberNames: ["Âº†‰∏Ä", "Êùé‰∫å", "Áéã‰∏â", "ËµµÂõõ", "Âë®‰∫î", "ÈÉëÂÖ≠"],
            group: "Á¨¨1ÁªÑ",
            selectedSubjects: [...ALL_SUBJECTS],
            darkMode: false
        };

        let evaluation = [];

        const container = document.getElementById('membersContainer');
        const modal = document.getElementById('settingsModal');
        const openBtn = document.getElementById('openSettingsBtn');
        const closeBtn = document.getElementById('closeModalBtn');
        const saveBtn = document.getElementById('saveSettingsBtn');
        const memberInputsDiv = document.getElementById('memberInputs');
        const groupSelect = document.getElementById('groupSelect');
        const subjectsDiv = document.getElementById('subjectsCheckboxGroup');
        const darkCheck = document.getElementById('darkModeCheckbox');
        const generateBtn = document.getElementById('generateReportBtn');
        const copyBtn = document.getElementById('copyReportBtn');
        const reportText = document.getElementById('reportText');

        function formatDate() {
            const d = new Date();
            return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
        }

        function createDefaultEvaluation() {
            const subjLen = settings.selectedSubjects.length;
            return settings.memberNames.map(() => 
                Array.from({ length: subjLen }, () => ({
                    checked: true,
                    completion: "ÂÆåÊàêËâØÂ•Ω",
                    font: "Â∑•Êï¥",
                    process: "ËøáÁ®ãÂÆåÊï¥"
                }))
            );
        }

        function persistAll() {
            localStorage.setItem('groupSettings', JSON.stringify(settings));
            localStorage.setItem('groupEvaluation', JSON.stringify(evaluation));
        }

        function loadFromStorage() {
            const savedSettings = localStorage.getItem('groupSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            if (!settings.selectedSubjects || settings.selectedSubjects.length === 0) {
                settings.selectedSubjects = [...ALL_SUBJECTS];
            }
            const savedEval = localStorage.getItem('groupEvaluation');
            if (savedEval) {
                try {
                    const parsed = JSON.parse(savedEval);
                    if (parsed.length === settings.memberNames.length && 
                        parsed[0]?.length === settings.selectedSubjects.length) {
                        evaluation = parsed;
                    } else {
                        evaluation = createDefaultEvaluation();
                    }
                } catch { evaluation = createDefaultEvaluation(); }
            } else {
                evaluation = createDefaultEvaluation();
            }
            applyDarkMode(settings.darkMode);
        }

        function applyDarkMode(enable) {
            document.body.classList.toggle('dark', enable);
            if (darkCheck) darkCheck.checked = enable;
        }

        function renderCards() {
            const subjList = settings.selectedSubjects;
            const memberNames = settings.memberNames;
            let html = '';

            for (let mIdx = 0; mIdx < memberNames.length; mIdx++) {
                const name = memberNames[mIdx] || `ÊàêÂëò${mIdx+1}`;
                html += `<div class="card" data-member="${mIdx}">`;
                html += `<div class="card-header"><span>üë§</span> ${name}</div>`;

                for (let sIdx = 0; sIdx < subjList.length; sIdx++) {
                    const subject = subjList[sIdx];
                    const evalItem = evaluation[mIdx]?.[sIdx] || { checked: true, completion: 'ÂÆåÊàêËâØÂ•Ω', font: 'Â∑•Êï¥', process: 'ËøáÁ®ãÂÆåÊï¥' };
                    const checkedAttr = evalItem.checked ? 'checked' : '';

                    html += `<div class="subject-row" data-subject="${sIdx}">`;
                    html += `<div class="subject-header">`;
                    html += `<span class="subject-name">${subject}</span>`;
                    html += `<input type="checkbox" class="subject-checkbox" id="chk_${mIdx}_${sIdx}" data-member="${mIdx}" data-subject="${sIdx}" ${checkedAttr}>`;
                    html += `<label for="chk_${mIdx}_${sIdx}">ËÆ°ÂÖ•Êä•Âëä</label>`;
                    html += `</div>`;

                    html += `<div class="dimensions">`;
                    // ÂÆåÊàêÁ®ãÂ∫¶
                    html += `<div class="dimension-group">`;
                    html += `<span class="dimension-label">ÂÆåÊàê</span>`;
                    html += `<div class="option-group" data-dim="completion">`;
                    COMPLETION_OPTS.forEach(opt => {
                        const selected = (opt === evalItem.completion) ? 'selected' : '';
                        html += `<button class="option-btn ${selected}" data-value="${opt}">${opt}</button>`;
                    });
                    html += `</div></div>`;

                    // Â≠ó‰Ωì
                    html += `<div class="dimension-group">`;
                    html += `<span class="dimension-label">Â≠ó‰Ωì</span>`;
                    html += `<div class="option-group" data-dim="font">`;
                    FONT_OPTS.forEach(opt => {
                        const selected = (opt === evalItem.font) ? 'selected' : '';
                        html += `<button class="option-btn ${selected}" data-value="${opt}">${opt}</button>`;
                    });
                    html += `</div></div>`;

                    // ËøáÁ®ã
                    html += `<div class="dimension-group">`;
                    html += `<span class="dimension-label">ËøáÁ®ã</span>`;
                    html += `<div class="option-group" data-dim="process">`;
                    PROCESS_OPTS.forEach(opt => {
                        const selected = (opt === evalItem.process) ? 'selected' : '';
                        html += `<button class="option-btn ${selected}" data-value="${opt}">${opt}</button>`;
                    });
                    html += `</div></div>`;
                    html += `</div>`; // .dimensions
                    html += `</div>`; // .subject-row
                }
                html += `</div>`; // .card
            }
            container.innerHTML = html;
        }

        container.addEventListener('click', (e) => {
            const btn = e.target.closest('.option-btn');
            if (btn) {
                e.preventDefault();
                const groupDiv = btn.closest('.option-group');
                if (!groupDiv) return;
                const dim = groupDiv.dataset.dim;
                const subjectRow = btn.closest('.subject-row');
                const card = btn.closest('.card');
                if (!subjectRow || !card) return;
                const memberIdx = card.dataset.member;
                const subjectIdx = subjectRow.dataset.subject;
                if (memberIdx === undefined || subjectIdx === undefined) return;
                const m = parseInt(memberIdx);
                const s = parseInt(subjectIdx);
                const value = btn.dataset.value;

                groupDiv.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                if (!evaluation[m]) evaluation[m] = [];
                if (!evaluation[m][s]) evaluation[m][s] = {};
                evaluation[m][s][dim] = value;
                persistAll();
                return;
            }

            const chk = e.target.closest('.subject-checkbox');
            if (chk) {
                // handled by change
            }
        });

        container.addEventListener('change', (e) => {
            const chk = e.target.closest('.subject-checkbox');
            if (!chk) return;
            const memberIdx = chk.dataset.member;
            const subjectIdx = chk.dataset.subject;
            if (memberIdx === undefined || subjectIdx === undefined) return;
            const m = parseInt(memberIdx);
            const s = parseInt(subjectIdx);
            if (!evaluation[m]) evaluation[m] = [];
            if (!evaluation[m][s]) evaluation[m][s] = {};
            evaluation[m][s].checked = chk.checked;
            persistAll();
        });

        function generateReport() {
            const subjList = settings.selectedSubjects;
            const memberNames = settings.memberNames;
            const group = settings.group;
            const now = new Date();
            const year = 2026;
            const month = now.getMonth() + 1;
            const day = now.getDate();
            let report = `${group}${year}Âπ¥${month}Êúà${day}Êó•‰Ωú‰∏öÊ£ÄÊü•ÊÉÖÂÜµ\n\n`;

            for (let sIdx = 0; sIdx < subjList.length; sIdx++) {
                const subject = subjList[sIdx];
                const lines = [];
                let hasAnyChecked = false;

                for (let mIdx = 0; mIdx < memberNames.length; mIdx++) {
                    const evalItem = evaluation[mIdx]?.[sIdx];
                    if (!evalItem || !evalItem.checked) continue;
                    hasAnyChecked = true;
                    const name = memberNames[mIdx];
                    const completion = evalItem.completion || 'ÂÆåÊàêËâØÂ•Ω';
                    const font = evalItem.font || 'Â∑•Êï¥';
                    const process = evalItem.process || 'ËøáÁ®ãÂÆåÊï¥';
                    lines.push(`${name}Ôºö${completion}ÔºåÂ≠ó‰Ωì${font}ÔºåËøáÁ®ã${process}`);
                }

                if (!hasAnyChecked) continue;
                report += `${subject}Ôºö\n`;
                lines.forEach(line => { report += `${line}\n`; });
                report += `\n`;
            }
            reportText.value = report.trim();
        }

        async function copyReport() {
            if (!reportText.value) return alert('Ê≤°ÊúâÊä•ÂëäÂèØÂ§çÂà∂');
            try {
                await navigator.clipboard.writeText(reportText.value);
                alert('Êä•ÂëäÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            } catch {
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©Â§çÂà∂');
            }
        }

        function populateModal() {
            let memberHtml = '';
            for (let i = 0; i < 6; i++) {
                const val = settings.memberNames[i] || '';
                memberHtml += `<div class="member-row"><input type="text" placeholder="ÁªÑÂëò${i+1}" value="${val.replace(/"/g, '&quot;')}"></div>`;
            }
            memberInputsDiv.innerHTML = memberHtml;
            groupSelect.value = settings.group;
            let subjectsHtml = '';
            ALL_SUBJECTS.forEach(sub => {
                const checked = settings.selectedSubjects.includes(sub) ? 'checked' : '';
                subjectsHtml += `<label><input type="checkbox" value="${sub}" ${checked}> ${sub}</label>`;
            });
            subjectsDiv.innerHTML = subjectsHtml;
            darkCheck.checked = settings.darkMode;
        }

        function collectAndSaveSettings() {
            const nameInputs = document.querySelectorAll('#memberInputs input');
            const newNames = [];
            nameInputs.forEach(input => newNames.push(input.value.trim() || `ÊàêÂëò${newNames.length+1}`));

            const newGroup = groupSelect.value;

            const subjChecks = document.querySelectorAll('#subjectsCheckboxGroup input[type="checkbox"]');
            const newSelectedSubjects = [];
            subjChecks.forEach(cb => { if (cb.checked) newSelectedSubjects.push(cb.value); });
            if (newSelectedSubjects.length === 0) {
                alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÁßëÁõÆ');
                return false;
            }

            const newDark = darkCheck.checked;

            const oldSettings = { ...settings };
            if (oldSettings.memberNames.join(',') !== newNames.join(',') || 
                oldSettings.selectedSubjects.join(',') !== newSelectedSubjects.join(',')) {
                settings.memberNames = newNames;
                settings.selectedSubjects = newSelectedSubjects;
                evaluation = createDefaultEvaluation();
            } else {
                settings.memberNames = newNames;
                settings.selectedSubjects = newSelectedSubjects;
            }
            settings.group = newGroup;
            settings.darkMode = newDark;

            applyDarkMode(newDark);
            persistAll();
            renderCards();
            return true;
        }

        openBtn.addEventListener('click', () => {
            populateModal();
            modal.classList.add('show');
        });
        closeBtn.addEventListener('click', () => {
            modal.classList.remove('show');
        });
        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('show');
        });
        saveBtn.addEventListener('click', () => {
            if (collectAndSaveSettings()) modal.classList.remove('show');
        });
        generateBtn.addEventListener('click', generateReport);
        copyBtn.addEventListener('click', copyReport);

        function init() {
            loadFromStorage();
            renderCards();
            if (!localStorage.getItem('groupSettings')) {
                populateModal();
                modal.classList.add('show');
            }
        }
        init();
    })();
</script>
</body>
</html>
